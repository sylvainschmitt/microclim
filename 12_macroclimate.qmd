```{r set}
#| message: false
#| include: false
library(tidyverse)
library(microclimr)
```

# Macroclimate {.unnumbered}

## ERA5-Land

@muñoz-sabater2021

```{r era}
#| message: false
#| warning: false
#| fig-cap: "ERA5-Land raw temperature data for Paracou."
era <- read_tsv("data/raw_data/macro/era5.tsv")
g_year <- era %>% 
  group_by(year = year(time)) %>% 
  summarise(tas = mean(tas)) %>% 
  ggplot(aes(year, tas)) +
  geom_line() +
  theme_bw() +
  theme(axis.title = element_blank())
g_month <- era %>% 
  group_by(month = month(time)) %>% 
  summarise(tas = mean(tas)) %>% 
  ggplot(aes(month, tas)) +
  geom_rect(xmin = 8, xmax = 12,
            ymin = -Inf, ymax = Inf, alpha = 0.5, fill  = "#fff4e0") +
  geom_line() +
  theme_bw() +
  theme(axis.title = element_blank()) +
  scale_x_continuous(breaks = 1:12,
                     labels = c("J", "F", "M", "A", "M", "J", "J", "A",
                                "S", "O", "N", "D"))
g_day <- era %>% 
  group_by(minute = minute(time)+60*hour(time)) %>% 
  summarise(tas = mean(tas)) %>% 
  ggplot(aes(minute/60, tas)) +
  geom_line() +
  theme_bw() +
  theme(axis.title = element_blank())
cowplot::plot_grid(g_year, g_month, g_day)
```

## Debiaising @hes2025

We computed back the correction of @hes2025 (see section 2 in SI) to determine a and b such $T_{ec} = \frac{T_e-b}{a}$ in order to correct ERA5-Land with Meteo France weather station data from Kourou CSG.

```{r weather_rel}
#| message: false
#| warning: false
#| fig-cap: "The temperature relationship between the hourly temperature at the weather station and the hourly temperature at ERA5-Land, as well as the correction factors a and b, following @hes2025.."
weather <- list.files("data/raw_data/macro/", pattern = "gz", full.names = TRUE) %>%
  read_delim(locale = locale(decimal_mark = "."), delim = ";") %>% 
  select(NOM_USUEL, LAT, LON, AAAAMMJJHH, RR1, TN50) %>%
  rename_all(tolower) %>%
  rename(loc = nom_usuel, pr = rr1, tas = tn50) %>%
  na.omit() %>% 
  mutate(aaaammjjhh = as.character(aaaammjjhh)) %>%
  mutate(year = str_sub(aaaammjjhh, 1, 4), 
         month = str_sub(aaaammjjhh, 5, 6),
         day = str_sub(aaaammjjhh, 7, 8),
         hour = str_sub(aaaammjjhh, 9, 10)) %>%
  mutate(time = as_datetime(paste0(year, "-", month, "-", day, 
                                   " ", hour, ":00:00"))) %>%
  select(loc, lat, lon, time, tas) %>% 
  filter(loc == "KOUROU CSG") %>% 
  left_join(read_tsv("data/raw_data/macro/era5_station.tsv") %>% 
              select(-lon, -lat),
            suffix = c("_station", "_era"), by = "time") %>% 
  na.omit()
a <- sd(weather$tas_era)/sd(weather$tas_station)
b <- mean(weather$tas_era)-a*mean(weather$tas_station)
weather %>% 
  ggplot(aes(tas_station, tas_era)) +
  geom_abline() +
  geom_point(alpha = .1, aes(col = hour(time))) +
  theme_bw() +
  coord_equal() +
  geom_smooth(method = "lm", se = FALSE) +
  ggpubr::stat_regline_equation(
    aes(label =  paste(..eq.label.., ..adj.rr.label.., sep = "~~~~")),
  ) +
  scale_color_viridis_c("Hour of the day") +
  xlab("Weather station hourly temperacture [°C]") +
  ylab("ERA5-Land hourly temperacture [°C]") +
  ggtitle(paste0("a = ", round(a, 2), " | b = ", round(b, 2)))
```

> The result differ from @hes2025 where $a=0.65$ and $b=8.72$. ⚠️ this correction as a strong effect on the resulting microclimatic buffer.

```{r weather}
#| message: false
#| warning: false
#| fig-cap: "MeteoFrance and ERA5-Land raw temperature data for Kourou CSG."
g_year <- weather %>% 
  mutate(tas_era_cor = (tas_era-13.5)/0.48) %>% 
  gather(type, tas, -loc, -lon, -lat, -time) %>% 
  group_by(type, year = year(time)) %>% 
  summarise(tas = mean(tas)) %>% 
  ggplot(aes(year, tas, col = type)) +
  geom_line() +
  theme_bw() +
  theme(axis.title = element_blank(),
        legend.position = "bottom")
g_month <- weather %>% 
  mutate(tas_era_cor = (tas_era-b)/a) %>% 
  gather(type, tas, -loc, -lon, -lat, -time) %>% 
  group_by(type, month = month(time)) %>% 
  summarise(tas = mean(tas)) %>% 
  ggplot(aes(month, tas, col = type)) +
  geom_rect(xmin = 8, xmax = 12, group = NA, col = NA,
            ymin = -Inf, ymax = Inf, alpha = 0.5, fill  = "#fff4e0") +
  geom_line() +
  theme_bw() +
  theme(axis.title = element_blank(),
        legend.position = "bottom") +
  scale_x_continuous(breaks = 1:12,
                     labels = c("J", "F", "M", "A", "M", "J", "J", "A",
                                "S", "O", "N", "D"))
g_day <- weather %>% 
  mutate(tas_era_cor = (tas_era-b)/a) %>% 
  gather(type, tas, -loc, -lon, -lat, -time) %>% 
  group_by(type, minute = minute(time)+60*hour(time)) %>% 
  summarise(tas = mean(tas)) %>% 
  ggplot(aes(minute/60, tas, col = type)) +
  geom_line() +
  theme_bw() +
  theme(axis.title = element_blank(),
        legend.position = "bottom")
cowplot::plot_grid(g_year, g_month, g_day)
```

## Debiaising Fourier

The problem with the debiasing of @hes2025 is that it depends on the time-frequency used. We therefore also attempted debiasing using the relationship between the Fourier coefficients after decomposition. We will use the full time series for the Fourier transform, but missing data cannot be allowed for. Our focus will be on the microclimate study years of 2023 and 2024. The weather station data only miss nine measurements on six different days; we will therefore simply fill these in using local linear interpolation. This gives us 365 and 366 days, multiplied by 24 hours (as 2024 is a leap year). This produced a very large power spectrum over two years, with most power at periods of 0, 24 hours, 12 hours and their harmonics, as well as between periods of two years and one day. Looking at the ratio of power between ERA and the weather station, we can see that, as the frequency increases, the ERA power is smaller than that observed. This is logical given that a reanalysis is expected to smooth out small temporal variations. Nonetheless, even at low frequencies and long periods above the day (24-hour period), the power of the weather station tends to be higher than the power of the ERA5-Land reanalysis. We can use this computed ratio for the Kourou CSG station to interpolate the debiased ERA5-Land back at the Paracou station for the years 2023 and 2024.

```{r missing}
#| message: false
#| warning: false
#| fig-cap: "Missing data from the MeteoFrance temperature data from Kourou CSG."
join <- read_tsv("data/raw_data/macro/era5_station.tsv") %>% 
  arrange(time) %>% 
  filter(year(time) %in% 2023:2024) %>% 
  rename(tas_era = tas) %>% 
  select(-lon, -lat) %>% 
  left_join(select(weather, time, tas_station)) %>% 
  mutate(date = as_date(time))
missing <- filter(join, is.na(tas_station)) %>% 
  select(date) %>% 
  unique()
join %>% 
  arrange(time) %>%
  mutate(tas_approx = zoo::na.approx(tas_station)) %>% 
  filter(date %in% missing$date) %>% 
  ggplot(aes(x = hour(time))) +
  geom_point(aes(y = tas_era, col = "era")) +
  geom_point(aes(y = tas_approx, col = "approx")) +
  geom_point(aes(y = tas_station, col = "station")) +
  facet_wrap(~ date) +
  theme_bw() +
  xlab("") +
  ylab("Temperature [°C]") 
```

```{r ps}
#| message: false
#| warning: false
#| fig-cap: "Power spectrums across 1-year for ERA5-Land and MeteoFrance temperature data from Kourou CSG."
fc <- join %>% 
  arrange(time) %>%
  mutate(tas_station = zoo::na.approx(tas_station)) %>% 
  filter(year(time) == 2023:2024) %>% 
  select(-date) %>% 
  gather(source, tas, -time) %>% 
  mutate(source = gsub("tas_", "", source)) %>% 
  group_by(source) %>% 
  do(fft = fft_tab(.$tas, 24*(365+366))) %>%
  unnest(fft)
g_sub <- fc %>% 
  filter(period >= 12) %>% 
  ggplot(aes(frequency, power+1, fill = source)) +
  geom_col(position = position_dodge()) +
  theme_bw() +
  xlab("Period [h]") +
  ylab("Power") +
  scale_y_log10() +
  scale_x_continuous(
    breaks = c(0, 1/(30*24), 1/(7*24), 1/48, 1/24, 1/12),
    labels = c("0", "1m", "7d", "48", "24", "12")
  ) +
  theme(legend.position = "none", 
        axis.title = element_blank())
fc %>% 
  ggplot(aes(frequency, power+1, fill = source)) +
  geom_col(position = position_dodge()) +
  theme_bw() +
  xlab("Period [h]") +
  ylab("Power") +
  scale_y_log10() +
  scale_x_continuous(
    breaks = c(0, 1 / 24, 1 / 12, 1 / 8, 1 / 6),
    labels = c("0", "24", "12", "8", "6")
  ) +
  theme(legend.position = "bottom") +
  annotation_custom(ggplotGrob(g_sub), 
                    ymin = 2, ymax = 30,
                    xmin = 1/12, xmax = 1/4)
```

```{r ratios}
#| message: false
#| warning: false
#| fig-cap: "Power spectrums ratios across 1-year for ERA5-Land and MeteoFrance temperature data from Kourou CSG."
ratios <- fc %>% 
  select(-power) %>% 
  pivot_wider(names_from = source, values_from = coefficient) %>% 
  mutate(ratio = era/station)
ratios %>% 
  filter(frequency <= 1/6) %>% 
  ggplot(aes(frequency, Mod(ratio))) +
  geom_point() +
  theme_bw() +
  scale_y_log10() +
  scale_x_continuous(
    breaks = c(0, 1/(7*24), 1/48, 1/24, 1/12, 1/8, 1/6),
    labels = c("0", "Week", "48", "24", "12", "8", "6")
  ) +
  xlab("Period [h]") +
  ylab("Mod of the ratio of coefficients for ERA / Station") +
  geom_smooth(method = "lm", se = FALSE)
```

## Reconstruction at Paracou

```{r}
#| message: false
#| warning: false
era <- read_tsv("data/raw_data/macro/era5.tsv") %>% 
  filter(year(time) %in% 2023:2024) %>% 
  select(-lon, -lat)
fc_cor <- fft_tab(era$tas, 24*(365+366)) %>% 
  left_join(select(ratios, frequency, period, ratio)) %>% 
  mutate(coefficient_c = coefficient*ratio)
era$tas_c0 <- fft_reconstruct(
  f = fc_cor$coefficient,
  freq = fc_cor$frequency[-1], 
  time = (1:(24*(365+366)))-1
)
era$tas_c1 <- fft_reconstruct(
  f = fc_cor$coefficient_c,
  freq = fc_cor$frequency[-1], 
  time = (1:(24*(365+366)))-1
)
era %>% 
  filter(time < as_datetime("2023-01-02 23:00:00")) %>% 
  gather(source, tas, -time) %>% 
  ggplot(aes(x = time, y = tas)) +
  geom_line() +
  theme_bw() +
  facet_wrap(~ source, nrow = 3)
```

```{r}
#| message: false
#| warning: false
#| fig-cap: "ERA5-Land raw and debiased temperature data for Paracou."
era <- read_tsv("data/raw_data/macro/era5.tsv") %>% 
  mutate(tas_cor = (tas-b)/a) %>% 
  rename(raw = tas, hes2025 = tas_cor) %>% 
  gather(type, tas, -time, -lon, -lat)
g_year <- era %>% 
  group_by(type, year = year(time)) %>% 
  summarise(tas = mean(tas)) %>% 
  ggplot(aes(year, tas, col = type)) +
  geom_line() +
  theme_bw() +
  theme(axis.title = element_blank())
g_month <- era %>% 
  group_by(type, month = month(time)) %>% 
  summarise(tas = mean(tas)) %>% 
  ggplot(aes(month, tas, col = type)) +
  geom_rect(xmin = 8, xmax = 12, group = NA, col = NA,
            ymin = -Inf, ymax = Inf, alpha = 0.5, fill  = "#fff4e0") +
  geom_line() +
  theme_bw() +
  theme(axis.title = element_blank()) +
  scale_x_continuous(breaks = 1:12,
                     labels = c("J", "F", "M", "A", "M", "J", "J", "A",
                                "S", "O", "N", "D"))
g_day <- era %>% 
  group_by(type, minute = minute(time)+60*hour(time)) %>% 
  summarise(tas = mean(tas)) %>% 
  ggplot(aes(minute/60, tas, col = type)) +
  geom_line() +
  theme_bw() +
  theme(axis.title = element_blank())
cowplot::plot_grid(g_year, g_month, g_day)
```
