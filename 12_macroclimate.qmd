```{r set}
#| message: false
#| include: false
library(tidyverse)
library(microclimr)
```

# Macroclimate {.unnumbered}

## ERA5-Land

@muñoz-sabater2021

```{r era}
#| message: false
#| warning: false
#| fig-cap: "ERA5-Land raw temperature data for Paracou."
era <- read_tsv("data/raw_data/macro/era5.tsv")
g_year <- era %>% 
  group_by(year = year(time)) %>% 
  summarise(tas = mean(tas)) %>% 
  ggplot(aes(year, tas)) +
  geom_line() +
  theme_bw() +
  theme(axis.title = element_blank())
g_month <- era %>% 
  group_by(month = month(time)) %>% 
  summarise(tas = mean(tas)) %>% 
  ggplot(aes(month, tas)) +
  geom_rect(xmin = 8, xmax = 12,
            ymin = -Inf, ymax = Inf, alpha = 0.5, fill  = "#fff4e0") +
  geom_line() +
  theme_bw() +
  theme(axis.title = element_blank()) +
  scale_x_continuous(breaks = 1:12,
                     labels = c("J", "F", "M", "A", "M", "J", "J", "A",
                                "S", "O", "N", "D"))
g_day <- era %>% 
  group_by(minute = minute(time)+60*hour(time)) %>% 
  summarise(tas = mean(tas)) %>% 
  ggplot(aes(minute/60, tas)) +
  geom_line() +
  theme_bw() +
  theme(axis.title = element_blank())
cowplot::plot_grid(g_year, g_month, g_day)
```

## Debiaising @hes2025

We computed back the correction of @hes2025 (see section 2 in SI) to determine a and b such $T_{ec} = \frac{T_e-b}{a}$ in order to correct ERA5-Land with Meteo France weather station data from Kourou CSG.

```{r weather_rel}
#| message: false
#| warning: false
#| fig-cap: "The temperature relationship between the hourly temperature at the weather station and the hourly temperature at ERA5-Land, as well as the correction factors a and b, following @hes2025.."
weather <- list.files("data/raw_data/macro/", pattern = "gz", full.names = TRUE) %>%
  read_delim(locale = locale(decimal_mark = "."), delim = ";") %>% 
  select(NOM_USUEL, LAT, LON, AAAAMMJJHH, RR1, TN50) %>%
  rename_all(tolower) %>%
  rename(loc = nom_usuel, pr = rr1, tas = tn50) %>%
  na.omit() %>% 
  mutate(aaaammjjhh = as.character(aaaammjjhh)) %>%
  mutate(year = str_sub(aaaammjjhh, 1, 4), 
         month = str_sub(aaaammjjhh, 5, 6),
         day = str_sub(aaaammjjhh, 7, 8),
         hour = str_sub(aaaammjjhh, 9, 10)) %>%
  mutate(time = as_datetime(paste0(year, "-", month, "-", day, 
                                   " ", hour, ":00:00"))) %>%
  select(loc, lat, lon, time, tas) %>% 
  filter(loc == "KOUROU CSG") %>% 
  left_join(read_tsv("data/raw_data/macro/era5_station.tsv") %>% 
              select(-lon, -lat),
            suffix = c("_station", "_era"), by = "time") %>% 
  na.omit()
a <- sd(weather$tas_era)/sd(weather$tas_station)
b <- mean(weather$tas_era)-a*mean(weather$tas_station)
weather %>% 
  ggplot(aes(tas_station, tas_era)) +
  geom_abline() +
  geom_point(alpha = .1, aes(col = hour(time))) +
  theme_bw() +
  coord_equal() +
  geom_smooth(method = "lm", se = FALSE) +
  ggpubr::stat_regline_equation(
    aes(label =  paste(..eq.label.., ..adj.rr.label.., sep = "~~~~")),
  ) +
  scale_color_viridis_c("Hour of the day") +
  xlab("Weather station hourly temperacture [°C]") +
  ylab("ERA5-Land hourly temperacture [°C]") +
  ggtitle(paste0("a = ", round(a, 2), " | b = ", round(b, 2)))
```

> The result differ from @hes2025 where $a=0.65$ and $b=8.72$. ⚠️ this correction as a strong effect on the resulting microclimatic buffer.

```{r weather}
#| message: false
#| warning: false
#| fig-cap: "MeteoFrance and ERA5-Land raw temperature data for Kourou CSG."
g_year <- weather %>% 
  mutate(tas_era_cor = (tas_era-13.5)/0.48) %>% 
  gather(type, tas, -loc, -lon, -lat, -time) %>% 
  group_by(type, year = year(time)) %>% 
  summarise(tas = mean(tas)) %>% 
  ggplot(aes(year, tas, col = type)) +
  geom_line() +
  theme_bw() +
  theme(axis.title = element_blank(),
        legend.position = "bottom")
g_month <- weather %>% 
  mutate(tas_era_cor = (tas_era-b)/a) %>% 
  gather(type, tas, -loc, -lon, -lat, -time) %>% 
  group_by(type, month = month(time)) %>% 
  summarise(tas = mean(tas)) %>% 
  ggplot(aes(month, tas, col = type)) +
  geom_rect(xmin = 8, xmax = 12, group = NA, col = NA,
            ymin = -Inf, ymax = Inf, alpha = 0.5, fill  = "#fff4e0") +
  geom_line() +
  theme_bw() +
  theme(axis.title = element_blank(),
        legend.position = "bottom") +
  scale_x_continuous(breaks = 1:12,
                     labels = c("J", "F", "M", "A", "M", "J", "J", "A",
                                "S", "O", "N", "D"))
g_day <- weather %>% 
  mutate(tas_era_cor = (tas_era-b)/a) %>% 
  gather(type, tas, -loc, -lon, -lat, -time) %>% 
  group_by(type, minute = minute(time)+60*hour(time)) %>% 
  summarise(tas = mean(tas)) %>% 
  ggplot(aes(minute/60, tas, col = type)) +
  geom_line() +
  theme_bw() +
  theme(axis.title = element_blank(),
        legend.position = "bottom")
cowplot::plot_grid(g_year, g_month, g_day)
```

## Debiaising Fourier

The problem with debiasing of @hes2025 is that it depends on the time frequency used. We therefore also attempted debiasing using the relationship between the Fourier coefficients after decomposition. Overall, apart from period 0, ERA5-Land showed less power than the Meteo-France weather station for all periods. However, it is not obvious how to adjust the coefficients. I would have used differences, ratios, or linear relationships. Looking at the relations between the coefficients for the 0-, 24-, 12- and 6-hour periods across time windows, the strength of the linear relationship decreases with the period. It is strong for the 0-hour period (83% goodness of fit), but decreases quickly and is not significant for the 6-hour period. *Should we use a larger time window and focus only on longer periods?*

```{r ps_debias}
#| message: false
#| warning: false
#| fig-cap: "Power spectrums across 5-days windows for ERA5-Land and MeteoFrance temperature data from Kourou CSG."
weather_f <- weather %>% 
  select(time, tas_station, tas_era) %>% 
  gather(source, tas, -time) %>% 
  mutate(source = gsub("tas_", "", source)) %>% 
  group_by(source) %>% 
  do(fft = fft_roll(
    data = .,
    t = 5*24,
    index_col = "time",
    temperature_col = "tas",
    window = "5 days",
    step = "3 days"
  )) %>%
  unnest(fft)
weather_f %>% 
  group_by(source, frequency, period) %>% 
  summarise(sd = sd(power), power = mean(power)) %>% 
  ggplot(aes(frequency, power+1, fill = source)) +
  geom_col(position = position_dodge()) +
  geom_linerange(aes(ymin = power+1-sd, ymax = power+1+sd), 
                 position = position_dodge(width = 0.01)) +
  theme_bw() +
  xlab("Period [h]") +
  ylab("Power") +
  scale_y_log10() +
  scale_x_continuous(
    breaks = c(0, 1 / 24, 1 / 12, 1 / 8, 1 / 6),
    labels = c("0", "24", "12", "8", "6")
  ) +
  theme(legend.position = c(0.8, 0.8))
```

```{r fs_relationships}
#| message: false
#| warning: false
#| fig-cap: "Fourier coefficients relationships for periods 0-, 24-, 12- and 6-hour between ERA5-Land and the MeteoFrance weather station in Kourou CSG."
weather_f %>% 
  select(-coefficient) %>% 
  pivot_wider(names_from = source, values_from = power) %>% 
  filter(period %in% c(0, 24, 12, 6)) %>% 
  ggplot(aes(station, era)) +
  geom_abline() +
  geom_point(alpha = .1) +
  theme_bw() +
  facet_wrap(~ period, scales = "free", labeller = label_both) +
  geom_smooth(method = "lm") +
  ggpubr::stat_regline_equation(
    aes(label =  paste(..eq.label.., ..adj.rr.label.., sep = "~~~~")),
  ) +
  xlab("Meteo-France Power") +
  ylab("ERA5-Land Power")
```

## Comparison

```{r}
#| message: false
#| warning: false
#| fig-cap: "ERA5-Land raw and debiased temperature data for Paracou."
era <- read_tsv("data/raw_data/macro/era5.tsv") %>% 
  mutate(tas_cor = (tas-b)/a) %>% 
  rename(raw = tas, hes2025 = tas_cor) %>% 
  gather(type, tas, -time, -lon, -lat)
g_year <- era %>% 
  group_by(type, year = year(time)) %>% 
  summarise(tas = mean(tas)) %>% 
  ggplot(aes(year, tas, col = type)) +
  geom_line() +
  theme_bw() +
  theme(axis.title = element_blank())
g_month <- era %>% 
  group_by(type, month = month(time)) %>% 
  summarise(tas = mean(tas)) %>% 
  ggplot(aes(month, tas, col = type)) +
  geom_rect(xmin = 8, xmax = 12, group = NA, col = NA,
            ymin = -Inf, ymax = Inf, alpha = 0.5, fill  = "#fff4e0") +
  geom_line() +
  theme_bw() +
  theme(axis.title = element_blank()) +
  scale_x_continuous(breaks = 1:12,
                     labels = c("J", "F", "M", "A", "M", "J", "J", "A",
                                "S", "O", "N", "D"))
g_day <- era %>% 
  group_by(type, minute = minute(time)+60*hour(time)) %>% 
  summarise(tas = mean(tas)) %>% 
  ggplot(aes(minute/60, tas, col = type)) +
  geom_line() +
  theme_bw() +
  theme(axis.title = element_blank())
cowplot::plot_grid(g_year, g_month, g_day)
```
