```{r set}
#| message: false
#| include: false
library(tidyverse)
library(microclimr)
```

# Macroclimate {.unnumbered}

## Comparisons

After debiasing, the ERA5-Land raw temperature showed a small bias compared to the local eddy-flux tower, suggesting that the forest boundary layer may simply have a buffering effect on the observed temperature at the flux tower.

```{r era_vs_guyaflux}
#| message: false
#| warning: false
#| fig-cap: "Comparison of ERA5-Land temperature against the local eddy-flux tower using hourly measumrents."
readxl::read_excel("data/raw_data/guyaflux/TourAFlux-2023-2024.xlsx", 
                               sheet = "Gx meteo_2023-2024",
                               col_types = c("date", rep("numeric", 29))) %>% 
  rename_all(tolower) %>% 
  rename(tas = `temp(55)`) %>% 
  select(date, tas) %>% 
  rename(time = date, tas_tower = tas) %>% 
  left_join(read_tsv("data/raw_data/macro/era5_station.tsv") %>% 
              mutate(tas = (tas-13.5)/0.48)) %>% 
  na.omit() %>% 
  ggplot(aes(tas_tower, tas)) +
  geom_abline() +
  geom_point() +
  theme_bw() +
  geom_smooth(method = "lm", se = FALSE) +
  ggpubr::stat_regline_equation(
    aes(label =  paste(..eq.label.., ..adj.rr.label.., sep = "~~~~"))
  ) +
  xlab("Temperature Guyaflux") +
  ylab("Temperature ERA5-Land")
```

## Power spectrum

The power spectrum revealed the expected daily strong power at 24-h period but also a lot of power at 12-hr period.

```{r spectrum}
#| message: false
#| warning: false
#| fig-cap: "Raw ERA5-Land power spectrum."
era_f <- read_tsv("data/raw_data/macro/era5.tsv") %>% 
  mutate(tas = (tas-8.72)/0.65) %>% 
  fft_roll(t = 5*24,
           index_col = "time",
           temperature_col = "tas")
era_f %>% 
  group_by(frequency, period) %>% 
  summarise(sd = sd(power), power = mean(power)) %>% 
  ggplot(aes(frequency, power+1)) +
  geom_col() +
  geom_linerange(aes(ymin = power+1-sd, ymax = power+1+sd)) +
  theme_bw() +
  xlab("Period [h]") +
  ylab("Power") +
  scale_x_continuous(
    breaks = c(0, 1 / 24, 1 / 12, 1 / 8, 1 / 6, 1 / 3),
    labels = c("0", "24", "12", "8", "6", "3")
  ) +
  theme(legend.position.inside = c(0.8, 0.8)) +
  scale_y_log10()
```

```{r power24}
#| message: false
#| warning: false
#| fig-cap: "Raw ERA5-Land power for period 24-hr variation across years and seasons."
era_f %>% 
  filter(period == 24) %>% 
  ggplot(aes(datetime, power)) +
  geom_line() +
  geom_point(aes(col = month(datetime) %in% 8:11)) +
  theme_bw() +
  xlab("") +
  ylab("Power for period 24-hr") +
  theme(legend.position = "bottom") +
  scale_color_discrete("Season", labels = c("Wet", "Dry"))
```
