```{r set}
#| message: false
#| include: false
library(tidyverse)
library(microclimr)
```

# Macroclimate {.unnumbered}

## Comparisons

ERA5-Land raw temperature presented a small bias when compared to the local eddy-flux tower but a strong bias when compared to MeteoFrance station near the sea. For the moment we chose not to correct them.

```{r era_vs_guyaflux}
#| message: false
#| warning: false
#| fig-cap: "Comparison of ERA5-Land temperature against the local eddy-flux tower using hourly measumrents."
readxl::read_excel("data/raw_data/guyaflux/TourAFlux-2023-2024.xlsx", 
                               sheet = "Gx meteo_2023-2024",
                               col_types = c("date", rep("numeric", 29))) %>% 
  rename_all(tolower) %>% 
  rename(tas = `temp(55)`) %>% 
  select(date, tas) %>% 
  rename(time = date, tas_tower = tas) %>% 
  left_join(read_tsv("data/raw_data/macro/era5_station.tsv")) %>% 
  na.omit() %>% 
  ggplot(aes(tas_tower, tas)) +
  geom_abline() +
  geom_point() +
  theme_bw() +
  geom_smooth(method = "lm", se = FALSE) +
  ggpubr::stat_regline_equation(
    aes(label =  paste(..eq.label.., ..adj.rr.label.., sep = "~~~~"))
  ) +
  xlab("Temperature Guyaflux") +
  ylab("Temperature ERA5-Land")
```

```{r era_vs_meteofrance}
#| message: false
#| warning: false
#| fig-cap: "Comparison of ERA5-Land temperature against MeteoFrance data for Kourou using daily means."
weather <- list.files("data/raw_data/macro/", pattern = "gz", full.names = TRUE) %>%
  read_delim(locale = locale(decimal_mark = "."), delim = ";") %>%
  select(NOM_USUEL, LAT, LON, AAAAMM, RR, TM, TMMAX, TMMIN) %>%
  rename_all(tolower) %>%
  rename(loc = nom_usuel, pr = rr, tas = tm, tasmin = tmmin, tasmax = tmmax) %>%
  mutate(pr = as.numeric(pr)) %>%
  mutate(aaaamm = as.character(aaaamm)) %>%
  mutate(year = str_sub(aaaamm, 1, 4), month = str_sub(aaaamm, 5, 6)) %>%
  mutate(date = as_date(paste0(year, "-", month, "-01"))) %>%
  select(loc, lat, lon, date, pr, tas, tasmin, tasmax) %>% 
  filter(loc == "KOUROU PLAGE") %>% 
  select(date, tas) %>% 
  rename(t_weather = tas)
era <- read_tsv("data/raw_data/macro/era5_station.tsv") %>% 
  rename(date = time, t_era = tas) %>% 
  select(date, t_era)
era %>% 
  left_join(weather) %>% 
  ggplot(aes(t_weather, t_era)) +
  geom_abline() +
  geom_point() +
  theme_bw() +
  geom_smooth(method = "lm", se = FALSE) +
  ggpubr::stat_regline_equation(
    aes(label =  paste(..eq.label.., ..adj.rr.label.., sep = "~~~~"))
  ) +
  xlab("Temperature MeteoFrance") +
  ylab("Temperature ERA5-Land")
```

## Power spectrum

The power spectrum revealed the expected daily strong power at 24-h period but also a lot of power at 12-hr period.

```{r spectrum}
#| message: false
#| warning: false
#| fig-cap: "Raw ERA5-Land power spectrum."
era_f <- read_tsv("data/raw_data/macro/era5.tsv") %>% 
  fft_roll(t = 5*24,
           index_col = "time",
           temperature_col = "tas")
era_f %>% 
  group_by(frequency, period) %>% 
  summarise(sd = sd(power), power = mean(power)) %>% 
  ggplot(aes(frequency, power)) +
  geom_col() +
  geom_linerange(aes(ymin = power-sd, ymax = power+sd)) +
  theme_bw() +
  xlab("Period [h]") +
  ylab("Power") +
  scale_x_continuous(
    breaks = c(0, 1 / 24, 1 / 12, 1 / 8, 1 / 6, 1 / 3),
    labels = c("0", "24", "12", "8", "6", "3")
  ) +
  theme(legend.position.inside = c(0.8, 0.8)) +
  scale_y_sqrt()
```

```{r power24}
#| message: false
#| warning: false
#| fig-cap: "Raw ERA5-Land power for period 24-hr variation across years and seasons."
era_f %>% 
  filter(period == 24) %>% 
  ggplot(aes(datetime, power)) +
  geom_line() +
  geom_point(aes(col = month(datetime) %in% 8:11)) +
  theme_bw() +
  xlab("") +
  ylab("Power for period 24-hr") +
  theme(legend.position = "bottom") +
  scale_color_discrete("Season", labels = c("Wet", "Dry"))
```
